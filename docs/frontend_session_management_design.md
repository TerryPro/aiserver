# 前端 AI 会话管理功能设计方案

## 1. 需求分析

目标是完善前端 AI 助手的会话管理能力，使其与 Jupyter Notebook 的 Cell 紧密关联。具体需求包括：
1.  **上下文关联**：AI 侧边栏/面板需感知当前激活的 Cell。
2.  **加载会话**：当选中某个 Cell 时，提供加载当前CELL关联的历史 AI 对话。
3.  **新建会话**：针对特定 Cell，允许用户清空当前上下文并开始新的对话（或重置会话）。

## 2. 交互设计 (UX)

### 2.1 侧边栏状态流转
AI 侧边栏的内容将随 Notebook 中激活 Cell 的变化而动态更新。

*   **场景 A：用户点击某个 Code Cell**
    1.  AI 插件监听到 `activeCellChanged` 事件。
    2.  获取当前 Notebook ID 和 Cell ID。
    3.  向后端请求该 `(notebook_id, cell_id)` 的历史会话数据。
    4.  **若有历史**：侧边栏“对话区域”自动渲染历史消息（User & AI）。
    5.  **若无历史**：显示欢迎/空状态，提示用户输入意图。

*   **场景 B：用户点击“新建会话/清空”按钮**
    1.  用户点击侧边栏顶部的“扫帚”图标（清空/新建）。
    2.  **前端行为**：清空当前显示的对话列表。
    3.  **后端行为**：(可选) 可以设计为逻辑删除或仅在前端重置，下次发送请求时后端会自动创建新记录（基于追加模式）或覆盖（取决于后端实现，目前后端是追加模式）。*建议：前端清空仅视觉重置，若需物理删除需调用 Delete API（待实现）。*

### 2.2 UI 布局方案

建议对现有的 `AiSidebar` 进行布局优化，分为三个区域：

```text
+------------------------------------------------------+
|  [Icon] AI Assistant             [⚙️ 设置] [🔄 重置] |  <-- 顶部工具栏
+------------------------------------------------------+
|                                                      |
|  [ 系统消息: 已加载 Cell [3] 的上下文... ]           |
|                                                      |
|  [User]                                              |
|  读取 data.csv                                       |
|                                                      |
|  [AI]                                                |
|  import pandas as pd...                              |
|  [应用代码] [复制]                                   |
|                                                      |
|           (滚动区域 - ChatHistory)                   |
|                                                      |
+------------------------------------------------------+
|  [ 变量: df (100x5) ▼ ]  [ 算法: None ▼ ]            |  <-- 上下文选择区
|  +------------------------------------------------+  |
|  | 输入您的需求... (Ctrl+Enter)                   |  |
|  +------------------------------------------------+  |
|  [生成代码] [修复错误] [解释代码]                    |  <-- 操作按钮区
+------------------------------------------------------+
```

**关键 UI 变更点**：
1.  **顶部工具栏**：增加“重置/新建会话”按钮，明确绑定当前 Cell。
2.  **状态提示**：在对话区顶部增加微弱提示，如“正在查看 Cell [x] 的会话”，让用户明确当前上下文。
3.  **自动加载**：无需用户手动点击“加载”，切换 Cell 即自动刷新。

